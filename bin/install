#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH

# Copy the version specific files into diy directory
cd $OPENSHIFT_FABRIC8_DIR/versions/$OPENSHIFT_FABRIC8_VERSION

for i in */* ; do
  if [[ $i == *.erb ]]; then
    erb $i > $OPENSHIFT_FABRIC8_DIR/container/${i%.*}
  else
	if [[ $i != 'system/org' ]] && [[ $i != 'fabric/import' ]] && [[ $i != 'm2/repository' ]]; then
    	cp $i $OPENSHIFT_FABRIC8_DIR/container/$i
    fi	
  fi
done

mkdir -p $OPENSHIFT_FABRIC8_DIR/container/m2/repository/
erb m2/repository/settings.xml.erb > $OPENSHIFT_FABRIC8_DIR/container/m2/repository/settings.xml


mkdir -p  $OPENSHIFT_FABRIC8_DIR/container/fabric/import/fabric/profiles/default.profile
erb fabric/import/fabric/profiles/default.profile/io.fabric8.agent.properties.erb > $OPENSHIFT_FABRIC8_DIR/container/fabric/import/fabric/profiles/default.profile/io.fabric8.agent.properties
erb fabric/import/fabric/profiles/org.ops4j.pax.url.mvn.properties.erb > $OPENSHIFT_FABRIC8_DIR/container/fabric/import/fabric/profiles/default.profile/org.ops4j.pax.url.mvn.properties

if [[ ! -z "${OPENSHIFT_FABRIC8_ECLIPSELINK_MOXY:-}" ]]; then
	cp -rf system $OPENSHIFT_FABRIC8_DIR/container
fi

cd $OPENSHIFT_FABRIC8_DIR
# Append shutdown configuration
echo "" >> container/etc/config.properties
echo "karaf.shutdown.host=${OPENSHIFT_FABRIC8_IP}" >> container/etc/config.properties
echo "karaf.shutdown.port=${OPENSHIFT_FABRIC8_SHUTDOWN_PORT}" >> container/etc/config.properties
# Limit the maximum number of created threads
echo "felix.threading.timeout=0" >> container/etc/config.properties
